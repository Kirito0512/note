# TCP Delayed ACK 与 Nagle 算法

## Delayed Ack

tcp 协议规定在接受到数据段时需要向对方发送一个确认，但如果只是单纯的发送一个确认，代价会比较高( 20 字节的 ip 首部， 20 字节的 tcp 首部)，最好能附带响应数据一起发送给对 方.所以 tcp 在何时发送 ack 给对方有以下规定:
- 当有响应数据要发送时， ack 会随响数据立即发送给对方 .
- 如果没有响应数据，ack 的发 送将会有一个延迟，以等待看是否有响应数据可以一起发送，这称是"Delayed Ack".但这个延迟最多不会超过 500 ms，一般为 200 ms.如果在 200 ms 内有数据要发送，那么 ack 会随数据一起立即发送给对方.注意这里的延迟 200 ms，不是指的从接受到对方数据到发送 ack 的最长等待时间差.而是指的内核启动的一个定时器，它每隔 200 ms 就查看下是否有 ack 要发送.
- 如果在等待发送 ack 期间，对方的第二个数据段又到达了，这时要立即发送 ack.

## Nagle 算法

Nagle算法是针对网络上存在的微小分组可能会在广域网上造成拥塞而设计的。该算法要求一个TCP连接上最多只能有一个未被确认的未完成的小分组，在该分组确认到达之前不能发送其他的小分组。同时，TCP 收集这些少量的分组，并在确认到来时以一个分组发出去。它的设计规则如下：

- 如果包长度达到最大报文长度（MSS，Maximum Segment Size），则允许发送；
- 如果该包含有 FIN，则允许发送；
- 设置了 TCP_NODELAY 选项，则允许发送；
- 未设置 TCP_CORK 选项时，若所有发出去的小数据包（包长度小于 MSS）均被确认，则允许发送；
- 上述条件都未满足，但发生了超时（一般为 200 ms），则立即发送。

## 200 ms 的延时

A 启用 nagle 算法，B 启用延时 ack

1. A 将第一个数据包写入发送缓存区，发送给 B；
2. B 接收到 A 的数据，但是没有数据要返回给 A；
3. A 将第二个数据写入发送缓冲区，但是第二个数据的长度小于 MSS；
4. A 不会立即发送第二个数据，会等待第一个数据的 ACK；
5. B 延时定时器（一般为 200 ms）到时后，发送第一个数据包的 ACK；
6. A 接收到 ACK ，发送第二个数据包。

如果 A 向 B 发送数据只需要 1 ms，但是由于延时 ACK 和 nagle 算法，花费了 201 ms。

解决办法：
- 发送端取消 nagle 算法（不推荐，可能会导致网络中出现各种小包，影响性能）
- 应用层取消 write-write read 的模式
- 关闭延迟 ack （暂时没找到解决方案）

## 参考链接

- [网络编程中的Socket详解---Delayed Ack(Ack确认延迟) && Nagle Algorithm(纳格算法)](https://www.tuicool.com/articles/YfM7nm)
- [TCP/IP之Nagle算法与40ms延迟](https://www.cnblogs.com/jiayayao/p/6217744.html)
